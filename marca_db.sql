-- SET search_path TO postgres, public;
-- DROP DATABASE marca_db;

-- CREATE DATABASE marca_db;
-- SET search_path TO marca_db, public;

-- Eliminar índices y tablas si ya existen

DROP TABLE IF EXISTS COMISION CASCADE;
DROP TABLE IF EXISTS TRANSACCION CASCADE;
DROP TABLE IF EXISTS TARJETA CASCADE;
DROP TABLE IF EXISTS SEGURIDAD_PROCESADOR CASCADE;
DROP TABLE IF EXISTS SEGURIDAD_POS CASCADE;
DROP TABLE IF EXISTS SEGURIDAD_GATEWAY CASCADE;
DROP TABLE IF EXISTS LIQUIDACION CASCADE;
DROP TABLE IF EXISTS CLIENTE CASCADE;
DROP TABLE IF EXISTS BANCO_EMISOR CASCADE;
DROP TABLE IF EXISTS BANCO_ADQUIRENTE CASCADE;

-- Crear tabla BANCO_ADQUIRENTE
CREATE TABLE BANCO_ADQUIRENTE (
    COD_BANCO_ADQUIRENTE INT NOT NULL,
    CODIGO_BIC VARCHAR(11) NOT NULL,
    NOMBRE VARCHAR(50) NOT NULL,
    PAIS VARCHAR(3) NOT NULL,
    CONSTRAINT PK_BANCO_ADQUIRENTE PRIMARY KEY (COD_BANCO_ADQUIRENTE)
);

-- Crear tabla BANCO_EMISOR
CREATE TABLE BANCO_EMISOR (
    COD_BANCO_EMISOR INT NOT NULL,
    NOMBRE VARCHAR(50) NOT NULL,
    PAIS VARCHAR(3) NOT NULL,
    CONSTRAINT PK_BANCO_EMISOR PRIMARY KEY (COD_BANCO_EMISOR)
);

-- Crear tabla CLIENTE
CREATE TABLE CLIENTE (
    COD_CLIENTE INT NOT NULL,
    NOMBRE VARCHAR(50) NOT NULL,
    APELLIDO VARCHAR(50) NOT NULL,
    DIRECCION_LINEA1 VARCHAR(100) NOT NULL,
    DIRECCION_LINEA2 VARCHAR(100),
    TELEFONO VARCHAR(15),
    CORREO VARCHAR(100),
    CONSTRAINT PK_CLIENTE PRIMARY KEY (COD_CLIENTE)
);

-- Crear tabla LIQUIDACION
CREATE TABLE LIQUIDACION (
    COD_LIQUIDACION INT NOT NULL,
    COD_BANCO_ADQUIRENTE INT NOT NULL,
    COD_BANCO_EMISOR INT NOT NULL,
    COD_COMISION INT,
    FECHA_LIQUIDACION TIMESTAMP(6) NOT NULL,
    TOTAL_LIQUIDADO NUMERIC(18,2) NOT NULL,
    TARIFAS NUMERIC(18,2) NOT NULL,
    CONSTRAINT PK_LIQUIDACION PRIMARY KEY (COD_LIQUIDACION)
);

-- Crear tabla SEGURIDAD_PROCESADOR
CREATE TABLE SEGURIDAD_PROCESADOR (
    COD_PROCESADOR INT NOT NULL,
    CLAVE VARCHAR(128) NOT NULL,
    FECHA_ACTUALIZACION DATE NOT NULL,
    FECHA_ACTIVACION DATE NOT NULL,
    ESTADO VARCHAR(3) NOT NULL CHECK (ESTADO IN ('APR', 'REC')),
    CONSTRAINT PK_SEGURIDAD_PROCESADOR PRIMARY KEY (COD_PROCESADOR)
);

-- Crear tabla TARJETA
CREATE TABLE TARJETA (
    COD_TARJETA INT NOT NULL,
    COD_BANCO_EMISOR INT NOT NULL,
    COD_CLIENTE INT NOT NULL,
    NUMERO_TARJETA VARCHAR(16) NOT NULL,
    NOMBRE_EN_TARJETA VARCHAR(50) NOT NULL,
    CVV_ VARCHAR(4) NOT NULL,
    FECHA_EXPIRACION DATE NOT NULL,
    TIPO_TARJETA VARCHAR(3) NOT NULL CHECK (TIPO_TARJETA IN ('DEB', 'CRE')),
    ESTADO_TARJETA VARCHAR(20) NOT NULL CHECK (ESTADO_TARJETA IN ('ACTIVA', 'SOBREGIRADA', 'ANULADA', 'FONDOS INSUFICIENTES', 'BLOQUEADA', 'EXPIRADA', 'INHABILITADA', 'INACTIVA', 'OTRO')),
    CONSTRAINT PK_TARJETA PRIMARY KEY (COD_TARJETA)
);

-- Crear tabla TRANSACCION
CREATE TABLE TRANSACCION (
    COD_TRANSACCION INT NOT NULL,
    COD_TARJETA INT NOT NULL,
    COD_LIQUIDACION INT,
    COD_PROCESADOR INT,
    COD_COMISION INT,
    FECHA_TRANSACCION TIMESTAMP(6) NOT NULL,
    MONTO NUMERIC(18,2) NOT NULL,
    ESTADO_ VARCHAR(3) NOT NULL CHECK (ESTADO_ IN ('APR', 'REC')),
    INTENTOS_VALIDACION INT,
    CODIGO_AUTORIZACION VARCHAR(10) NOT NULL,
    TIPO_TRANSACCION VARCHAR(20) NOT NULL,
    MONEDA VARCHAR(3) NOT NULL,
    PAIS_ORIGEN VARCHAR(3) NOT NULL,
    CODIGO_RESPUESTA VARCHAR(50) NOT NULL, -- IN ('OK', 'SOBREGIRADA', 'ANULADA', 'FONDOS INSUFICIENTES', 'BLOQUEADA', 'EXPIRADA', 'INHABILITADA', 'INACTIVA', 'OTRO')
    COMISION_MARCA NUMERIC(18,2),
    CANAL VARCHAR(20) NOT NULL,
    CONSTRAINT PK_TRANSACCION PRIMARY KEY (COD_TRANSACCION)
);

-- Crear tabla COMISION
CREATE TABLE COMISION (
    COD_COMISION INT NOT NULL,
    MARCA VARCHAR(20) NOT NULL,
    PREFIJO_MARCA VARCHAR(5) NOT NULL,
    TIPO VARCHAR(15) NOT NULL,
    PAIS VARCHAR(3) NOT NULL,
    COMISION_INTERNACIONAL NUMERIC(18,4),
    COMISION_LOCAL NUMERIC(18,4),
    TIPO_COMISION VARCHAR(15) NOT NULL,
    COMISION_FIJA NUMERIC(18,4),
    ESTADO VARCHAR(10) NOT NULL,
    FECHA_CREACION DATE NOT NULL,
    DESCRIPCION VARCHAR(100),
    CONSTRAINT PK_COMISION PRIMARY KEY (COD_COMISION)
);

-- Agregar claves foráneas con ALTER TABLE
ALTER TABLE LIQUIDACION
ADD CONSTRAINT FK_LIQUIDAC_BANCO_AD FOREIGN KEY (COD_BANCO_ADQUIRENTE)
REFERENCES BANCO_ADQUIRENTE (COD_BANCO_ADQUIRENTE)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE LIQUIDACION
ADD CONSTRAINT FK_LIQUIDAC_BANCO_EM FOREIGN KEY (COD_BANCO_EMISOR)
REFERENCES BANCO_EMISOR (COD_BANCO_EMISOR)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE TARJETA
ADD CONSTRAINT FK_TARJETA_BANCO_EM FOREIGN KEY (COD_BANCO_EMISOR)
REFERENCES BANCO_EMISOR (COD_BANCO_EMISOR)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE TARJETA
ADD CONSTRAINT FK_TARJETA_CLIENTE FOREIGN KEY (COD_CLIENTE)
REFERENCES CLIENTE (COD_CLIENTE)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE TRANSACCION
ADD CONSTRAINT FK_TRANSACCION_TARJETA FOREIGN KEY (COD_TARJETA)
REFERENCES TARJETA (COD_TARJETA)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE TRANSACCION
ADD CONSTRAINT FK_TRANSACCION_LIQUIDACION FOREIGN KEY (COD_LIQUIDACION)
REFERENCES LIQUIDACION (COD_LIQUIDACION)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE TRANSACCION
ADD CONSTRAINT FK_TRANSACCION_PROCESADOR FOREIGN KEY (COD_PROCESADOR)
REFERENCES SEGURIDAD_PROCESADOR (COD_PROCESADOR)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE TRANSACCION
ADD CONSTRAINT FK_TRANSACCION_COMISION FOREIGN KEY (COD_COMISION)
REFERENCES COMISION (COD_COMISION)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE LIQUIDACION
ADD CONSTRAINT FK_LIQUIDACION_COMISION FOREIGN KEY (COD_COMISION)
REFERENCES COMISION (COD_COMISION)
ON DELETE RESTRICT ON UPDATE RESTRICT;

-- Insertar datos iniciales
INSERT INTO BANCO_ADQUIRENTE (COD_BANCO_ADQUIRENTE, CODIGO_BIC, NOMBRE, PAIS) VALUES
(1, 'BIC12345678', 'Banco Adquiriente 1', 'ECU'),
(2, 'BIC87654321', 'Banco Adquiriente 2', 'USA');

INSERT INTO BANCO_EMISOR (COD_BANCO_EMISOR, NOMBRE, PAIS) VALUES
(1, 'Banco Emisor 1', 'ECU'),
(2, 'Banco Emisor 2', 'USA');

INSERT INTO CLIENTE (COD_CLIENTE, NOMBRE, APELLIDO, DIRECCION_LINEA1, DIRECCION_LINEA2, TELEFONO, CORREO) VALUES
(1, 'Juan', 'Pérez', 'Av. Principal 123', 'Edificio Central', '0987654321', 'juan.perez@example.com'),
(2, 'Ana', 'Gómez', 'Calle Secundaria 456', 'Conjunto Jardines', '0998765432', 'ana.gomez@example.com');

INSERT INTO LIQUIDACION (COD_LIQUIDACION, COD_BANCO_ADQUIRENTE, COD_BANCO_EMISOR, FECHA_LIQUIDACION, TOTAL_LIQUIDADO, TARIFAS) VALUES
(1, 1, 1, '2025-01-01', 1000.00, 50.00),
(2, 2, 2, '2025-01-02', 2000.00, 100.00);

INSERT INTO SEGURIDAD_PROCESADOR (COD_PROCESADOR, CLAVE, FECHA_ACTUALIZACION, FECHA_ACTIVACION, ESTADO) VALUES
(1, 'ClaveProcesador1', '2025-01-01', '2025-01-01', 'APR'),
(2, 'ClaveProcesador2', '2025-01-02', '2025-01-02', 'REC');

INSERT INTO TARJETA (COD_TARJETA, COD_BANCO_EMISOR, COD_CLIENTE, NUMERO_TARJETA, NOMBRE_EN_TARJETA, CVV_, FECHA_EXPIRACION, TIPO_TARJETA, ESTADO_TARJETA) VALUES
(1, 1, 1, '1234567812345678', 'MARIA FERNANDEZ', '123', '2025-12-01', 'CRE', 'ACTIVA'),
(2, 2, 2, '8765432187654321', 'DARIO RUALES', '456', '2025-11-01', 'DEB', 'ACTIVA');

INSERT INTO TRANSACCION (COD_TRANSACCION, COD_TARJETA, COD_LIQUIDACION, COD_PROCESADOR, FECHA_TRANSACCION, MONTO, ESTADO_, INTENTOS_VALIDACION, CODIGO_AUTORIZACION, TIPO_TRANSACCION, MONEDA, PAIS_ORIGEN, CODIGO_RESPUESTA, COMISION_MARCA, CANAL) VALUES
(1, 1, 1, 1, '2025-01-01', 100.50, 'APR', 1, 'AUTH123', 'COMPRA', 'USD', 'ECU', 'OK', 5.00, 'WEB'),
(2, 2, 2, 2, '2025-01-02', 200.75, 'REC', 2, 'AUTH456', 'RETIRO', 'USD', 'USA', 'FONDOS INSUFICIENTES', 10.00, 'POS');

INSERT INTO COMISION (COD_COMISION, MARCA, PREFIJO_MARCA, TIPO, PAIS, COMISION_INTERNACIONAL, COMISION_LOCAL,
                      TIPO_COMISION, COMISION_FIJA, ESTADO, FECHA_CREACION, DESCRIPCION) VALUES
(6001, 'VISA', 'VI', 'CREDITO', 'ECU', 0.018, 0.015, 'PORCENTAJE', 0.1, 'ACTIVO', '2024-01-01', 'comision de ecu para visa tarjeta de credito'),
(5002, 'VISA', 'VI', 'DEBITO', 'ECU', 0.03, 0.02, 'PORCENTAJE', 0.15, 'ACTIVO', '2024-01-01', ''),
(5003, 'VISA', 'VI', 'LIQUIDACION', 'ECU', 20, 10, 'FIJO', 0, 'ACTIVO', '2024-01-01', ''),
(5004, 'VISA', 'VI', 'CREDITO', 'PER', 0.017, 0.014, 'PORCENTAJE', 0.08, 'ACTIVO', '2024-01-01', ''),
(5005, 'VISA', 'VI', 'DEBITO', 'PER', 0.028, 0.018, 'PORCENTAJE', 0.12, 'ACTIVO', '2024-01-01', ''),
(5006, 'VISA', 'VI', 'LIQUIDACION', 'PER', 20, 10, 'FIJO', 0, 'ACTIVO', '2024-01-01', ''),
(5007, 'VISA', 'VI', 'CREDITO', 'USA', 0.03, 0.02, 'PORCENTAJE', 0.25, 'ACTIVO', '2024-01-01', ''),
(5008, 'VISA', 'VI', 'DEBITO', 'USA', 0.03, 0.025, 'PORCENTAJE', 0.3, 'ACTIVO', '2024-01-01', ''),
(5009, 'VISA', 'VI', 'LIQUIDACION', 'USA', 20, 10, 'FIJO', 0, 'ACTIVO', '2024-01-01', ''),
(5010, 'MASTERCARD', 'MA', 'CREDITO', 'ECU', 0.018, 0.015, 'PORCENTAJE', 0.1, 'ACTIVO', '2024-01-01', ''),
(5011, 'MASTERCARD', 'MA', 'DEBITO', 'ECU', 0.03, 0.02, 'PORCENTAJE', 0.15, 'ACTIVO', '2024-01-01', ''),
(5012, 'MASTERCARD', 'MA', 'CREDITO', 'PER', 0.017, 0.014, 'PORCENTAJE', 0.08, 'ACTIVO', '2024-01-01', ''),
(5013, 'MASTERCARD', 'MA', 'DEBITO', 'PER', 0.028, 0.018, 'PORCENTAJE', 0.12, 'ACTIVO', '2024-01-01', ''),
(5014, 'MASTERCARD', 'MA', 'CREDITO', 'USA', 0.03, 0.02, 'PORCENTAJE', 0.25, 'ACTIVO', '2024-01-01', ''),
(5015, 'MASTERCARD', 'MA', 'DEBITO', 'USA', 0.03, 0.025, 'PORCENTAJE', 0.3, 'ACTIVO', '2024-01-01', ''),
(5016, 'AMERICAN EXPRESS', 'AE', 'CREDITO', 'USA', 2.5, 3, 'FIJO', 0, 'ACTIVO', '2024-01-01', ''),
(5017, 'UNION PAY', 'UP', 'CREDITO', 'USA', 0.015, 0.02, 'FIJO', 0, 'ACTIVO', '2024-01-01', '')
;

